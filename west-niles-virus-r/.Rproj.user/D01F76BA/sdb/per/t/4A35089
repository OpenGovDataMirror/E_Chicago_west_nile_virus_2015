{
    "contents" : "##############################################################\n## load data\n##############################################################\nrm(list = ls())\nsource(\"fn.base.R\")\n\ntic()\ncat(\"Loading ensenble data... \\n\")\n\ndata.ens.cols <- c(\n  \"data.rgf.01.pred.smth\",\n  \"data.gbc.01.pred.smth\"\n)\n\ndata.ens.pred <- fn.load.ens(ens.cols = data.ens.cols, print.err = F)\n\nStore(data.ens.pred)\n\n\nfn.data.mult.m.pred <- function(x) {\n  fn.apply.mult(data.pred=x, data.mult = data.mult.m.01)\n}\n\ndata.ens.my.pred <- fn.load.ens(ens.cols = data.ens.cols,\n                                transf = fn.data.mult.m.pred,\n                                print.err = F)\n\nStore(data.ens.my.pred)\n\ncols.ens.all <- setdiff(colnames(data.ens.my.pred), \"Id\")\ndata.ens.all.pred <- merge(\n  data.ens.my.pred,\n  data.ens.pred, \n  by=\"Id\", suffixes = c(\".y\", \".my\"))\n\ndata.ens.all.pred <- fn.add.date.fields(data.ens.all.pred)\ndata.ens.all.pred <- merge(\n  data.ens.all.pred,\n  data.all.trap[, list(Id, Species)],\n  by=\"Id\"\n)\n\n## add some hand crafted multipliers\n\nfor (col.nam in cols.ens.all) { \n  col.nam.y <- paste0(col.nam, \".y\")\n  col.nam.my <- paste0(col.nam, \".my\")\n  data.ens.all.pred[, col.nam := (1*get(col.nam.y) + \n                                        6*get(col.nam.my))/7, with=F]\n  \n  fn.multiplier <- function(yr, mnth, mult) {\n    data.ens.all.pred[get(\"Year\") == yr & get(\"Month\") == mnth, \n                    col.nam := get(col.nam)*mult, with=F]\n  }\n  \n  fn.multiplier(yr=2012, mnth=7, mult=1.6)\n  \n  fn.multiplier(yr=2012, mnth=9, mult=0.3)\n  \n  fn.multiplier(yr=2012, mnth=8, mult=0.8)\n  \n  fn.multiplier(yr=2008, mnth=9, mult=1.2)\n\n  fn.multiplier(yr=2008, mnth=7, mult=0.85)\n  \n  \n  data.ens.all.pred[\n    get(\"Year\") == 2012 & get(\"Month\")== 8 & get(\"WeekYear\") == 35, \n    col.nam := get(col.nam)*0.3, with=F]\n  \n  data.ens.all.pred[\n    get(\"Year\") == 2012 & get(\"Month\")==8 & get(\"WeekYear\") == 34, \n    col.nam := get(col.nam)*0.3, with=F]\n  \n  data.ens.all.pred[\n    get(\"Year\") == 2012 & get(\"WeekYear\") == 32, \n    col.nam := get(col.nam)*0.7, with=F]\n  \n  data.ens.all.pred[\n    get(\"Year\") == 2012 &  get(\"WeekYear\") == 31, \n    col.nam := get(col.nam)*1.6, with=F]\n  \n  data.ens.all.pred[\n    get(\"Year\") == 2012 & get(\"WeekYear\") == 30, \n    col.nam := get(col.nam)*1.6, with=F]\n  \n  data.ens.all.pred[\n    get(\"Year\") == 2012 & get(\"WeekYear\") == 29, \n    col.nam := get(col.nam)*1.1, with=F]\n  \n  data.ens.all.pred[\n    get(\"Year\") == 2012 & get(\"Month\")== 7 & get(\"WeekYear\") == 28, \n    col.nam := get(col.nam)*0.9, with=F]\n  \n  data.ens.all.pred[\n    get(\"Species\") == \"CULEX PIPIENS\", \n    col.nam := get(col.nam)*0.5, with=F]\n  \n  data.ens.all.pred[\n    get(\"Species\") == \"CULEX RESTUANS\", \n    col.nam := get(col.nam)*0.9, with=F]\n  \n  data.ens.all.pred[, col.nam.y := NULL, with=F]\n  data.ens.all.pred[, col.nam.my := NULL, with=F]\n}\n\ndata.ens.all.pred <- data.ens.all.pred[, c(\"Id\", cols.ens.all), with=F]\n\nStore(data.ens.all.pred)\n\ntoc()\n\n##############################################################\n## create ensenble\n##############################################################\ntic()\ncat(\"Creating ensenble... \\n\")\n\nexpr.ens <- quote(\n  3*rank(rgf.01) + 1*rank(gbc.01)\n)\n\ndata.ens.all.pred.sub <- copy(data.ens.all.pred)\ndata.ens.all.pred.sub[, Pred := 0.0]\ndata.ens.all.pred.sub[rgf.01 > 0, Pred := eval(expr.ens)]\n\nStore(data.ens.all.pred.sub)\n\nfn.write.submission(data.ens.all.pred.sub, \"data.ens.all.pred.sub\") \n\n# data.ens.all.ord.list <- list()\n# for (rem in c(0:1)) {\n#   data.ens.all.ord <- fn.calc.pred.month.mean(data.ens.all.pred.sub)[Year %% 2 == rem]\n#   data.ens.all.ord <- merge(\n#     data.ens.all.ord, data.mult.m.01[,list(Year, Month, AUC)], \n#     by=c(\"Year\", \"Month\")\n#   )\n#   data.ens.all.ord[,RankMean := rank(-Mean)]\n#   data.ens.all.ord[,RankAUC := rank(-AUC)]\n#   data.ens.all.ord[,RankDiff := rank(-Mean) - rank(-AUC)]\n#   data.ens.all.ord <- data.ens.all.ord[order(-AUC)]\n#   \n#   data.ens.all.ord.list[[rem+1]] <- data.ens.all.ord\n# }\n# print(data.ens.all.ord.list[[1]])\n# print(data.ens.all.ord.list[[1]][order(-Mean)])\n\n\n\ntoc()\n\n\n",
    "created" : 1434916611326.000,
    "dirty" : true,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1282847846",
    "id" : "4A35089",
    "lastKnownWriteTime" : 1434919772,
    "path" : "~/Dropbox/WestNile2015/final_code/west-niles-virus-r/03 - train.ens.R",
    "project_path" : "03 - train.ens.R",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}